<!DOCTYPE html>
<html>
  <head>
    <title>Comprehensive Extension Debug</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        line-height: 1.6;
      }
      .debug-section {
        margin: 20px 0;
        padding: 15px;
        border: 2px solid #ccc;
        border-radius: 8px;
        background: #f9f9f9;
      }
      .test-field {
        margin: 10px 0;
        padding: 8px;
        width: 300px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-primary {
        background: #007bff;
        color: white;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-warning {
        background: #ffc107;
        color: black;
      }
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        max-height: 300px;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .status.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
      }
      .status.info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
      }
    </style>
  </head>
  <body>
    <h1>üîß Comprehensive Extension Debug Tool</h1>

    <div class="debug-section">
      <h2>üåê Browser Information</h2>
      <div id="browserInfo">Loading...</div>
    </div>

    <div class="debug-section">
      <h2>üîå Extension Status</h2>
      <div id="extensionStatus">Checking...</div>
      <button class="btn-primary" onclick="checkExtensionStatus()">
        Refresh Status
      </button>
    </div>

    <div class="debug-section">
      <h2>üìù Test Form Fields</h2>
      <p>Click on any field to test suggestions:</p>
      <input
        type="text"
        id="firstName"
        name="firstName"
        placeholder="First Name"
        class="test-field"
      />
      <input
        type="text"
        id="lastName"
        name="lastName"
        placeholder="Last Name"
        class="test-field"
      />
      <input
        type="email"
        id="email"
        name="email"
        placeholder="Email"
        class="test-field"
      />
      <input
        type="tel"
        id="phone"
        name="phone"
        placeholder="Phone"
        class="test-field"
      />
    </div>

    <div class="debug-section">
      <h2>üß™ Popup Tests</h2>
      <button class="btn-success" onclick="testBasicPopup()">
        Test Basic Popup
      </button>
      <button class="btn-warning" onclick="testSuggestionPopup()">
        Test Suggestion Popup
      </button>
      <button class="btn-danger" onclick="testBravePopup()">
        Test Brave Popup
      </button>
    </div>

    <div class="debug-section">
      <h2>üíæ Storage Test</h2>
      <button class="btn-primary" onclick="testStorage()">
        Test Storage Access
      </button>
      <button class="btn-success" onclick="saveTestData()">
        Save Test Data
      </button>
      <div id="storageResult"></div>
    </div>

    <div class="debug-section">
      <h2>üì® Message Test</h2>
      <button class="btn-primary" onclick="testMessages()">
        Test Background Messages
      </button>
      <div id="messageResult"></div>
    </div>

    <div class="debug-section">
      <h2>üìã Fill Forms Test</h2>
      <button class="btn-warning" onclick="testFillForms()">
        Test Fill Forms Function
      </button>
      <div id="fillFormsResult"></div>
    </div>

    <div class="debug-section">
      <h2>üìä Console Logs</h2>
      <pre id="consoleLogs">Console logs will appear here...</pre>
      <button class="btn-primary" onclick="clearLogs()">Clear Logs</button>
    </div>

    <script>
      let logs = [];

      // Override console.log to capture logs
      const originalLog = console.log;
      console.log = function (...args) {
        originalLog.apply(console, args);
        logs.push(args.join(" "));
        updateLogDisplay();
      };

      function updateLogDisplay() {
        document.getElementById("consoleLogs").textContent = logs
          .slice(-20)
          .join("\n");
      }

      function clearLogs() {
        logs = [];
        updateLogDisplay();
      }

      // Browser detection
      function detectBrowser() {
        const userAgent = navigator.userAgent;
        const vendor = navigator.vendor;

        let browser = "Unknown";
        if (
          userAgent.indexOf("Chrome") !== -1 &&
          vendor.indexOf("Google") !== -1
        ) {
          browser = "Chrome";
        } else if (
          userAgent.indexOf("Chrome") !== -1 &&
          vendor.indexOf("Google") === -1
        ) {
          browser = "Brave or Chromium-based";
        } else if (userAgent.indexOf("Firefox") !== -1) {
          browser = "Firefox";
        } else if (userAgent.indexOf("Safari") !== -1) {
          browser = "Safari";
        } else if (userAgent.indexOf("Edge") !== -1) {
          browser = "Edge";
        }

        return {
          browser,
          userAgent,
          vendor,
          isBrave: navigator.brave !== undefined,
          hasChrome: !!window.chrome,
          hasExtensionAPI: !!window.chrome?.runtime,
        };
      }

      function displayBrowserInfo() {
        const info = detectBrowser();
        document.getElementById("browserInfo").innerHTML = `
                <div class="status info">
                    <strong>Browser:</strong> ${info.browser}<br>
                    <strong>Brave Detected:</strong> ${
                      info.isBrave ? "Yes" : "No"
                    }<br>
                    <strong>Chrome API:</strong> ${
                      info.hasChrome ? "Available" : "Not Available"
                    }<br>
                    <strong>Extension API:</strong> ${
                      info.hasExtensionAPI ? "Available" : "Not Available"
                    }<br>
                    <strong>User Agent:</strong> ${info.userAgent}<br>
                    <strong>Vendor:</strong> ${info.vendor}
                </div>
            `;
      }

      function checkExtensionStatus() {
        let status = "";

        if (typeof jobApplicationFiller !== "undefined") {
          status +=
            '<div class="status success">‚úÖ Content Script Loaded</div>';
          status += `<div class="status info">
                    <strong>Settings:</strong><br>
                    ‚Ä¢ Enabled: ${jobApplicationFiller.isEnabled}<br>
                    ‚Ä¢ Show Suggestions: ${jobApplicationFiller.showSuggestions}<br>
                    ‚Ä¢ Save New Data: ${jobApplicationFiller.saveNewData}
                </div>`;
        } else {
          status +=
            '<div class="status error">‚ùå Content Script Not Found</div>';
        }

        if (window.chrome && window.chrome.runtime) {
          status +=
            '<div class="status success">‚úÖ Chrome Extension API Available</div>';
        } else {
          status +=
            '<div class="status error">‚ùå Chrome Extension API Not Available</div>';
        }

        document.getElementById("extensionStatus").innerHTML = status;
      }

      function testBasicPopup() {
        const popup = document.createElement("div");
        popup.innerHTML = "BASIC TEST POPUP";
        popup.style.cssText = `
                position: fixed;
                top: 50px;
                right: 50px;
                width: 200px;
                height: 100px;
                background: green;
                color: white;
                z-index: 999999;
                padding: 20px;
                border: 2px solid black;
                font-weight: bold;
            `;
        document.body.appendChild(popup);

        setTimeout(() => popup.remove(), 3000);
        console.log("Basic popup test executed");
      }

      function testSuggestionPopup() {
        const field = document.getElementById("firstName");
        if (typeof jobApplicationFiller !== "undefined" && field) {
          jobApplicationFiller.testSuggestionPopup(field);
          console.log("Suggestion popup test executed");
        } else {
          console.log(
            "Cannot test suggestion popup - content script or field not available"
          );
        }
      }

      function testBravePopup() {
        if (
          typeof jobApplicationFiller !== "undefined" &&
          jobApplicationFiller.testBravePopup
        ) {
          const field = document.getElementById("firstName");
          jobApplicationFiller.testBravePopup(field);
          console.log("Brave popup test executed");
        } else if (typeof testBrave !== "undefined") {
          testBrave();
          console.log("Brave test function executed");
        } else {
          console.log("Cannot test Brave popup - function not available");
        }
      }

      async function testStorage() {
        try {
          const result = await chrome.storage.local.get(null);
          document.getElementById("storageResult").innerHTML = `
                    <div class="status success">‚úÖ Storage Access Working</div>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
          console.log("Storage test successful:", result);
        } catch (error) {
          document.getElementById("storageResult").innerHTML = `
                    <div class="status error">‚ùå Storage Access Failed: ${error.message}</div>
                `;
          console.log("Storage test failed:", error);
        }
      }

      async function saveTestData() {
        try {
          const testData = {
            userData: {
              firstName: "John",
              lastName: "Doe",
              email: "john.doe@example.com",
              phone: "+1-555-123-4567",
            },
            testTimestamp: new Date().toISOString(),
          };

          await chrome.storage.local.set(testData);
          document.getElementById("storageResult").innerHTML = `
                    <div class="status success">‚úÖ Test Data Saved Successfully</div>
                `;
          console.log("Test data saved:", testData);
        } catch (error) {
          document.getElementById("storageResult").innerHTML = `
                    <div class="status error">‚ùå Save Test Data Failed: ${error.message}</div>
                `;
          console.log("Save test data failed:", error);
        }
      }

      async function testMessages() {
        try {
          chrome.runtime.sendMessage({ action: "getUserData" }, (response) => {
            if (chrome.runtime.lastError) {
              document.getElementById("messageResult").innerHTML = `
                            <div class="status error">‚ùå Message Failed: ${chrome.runtime.lastError.message}</div>
                        `;
              console.log("Message test failed:", chrome.runtime.lastError);
            } else {
              document.getElementById("messageResult").innerHTML = `
                            <div class="status success">‚úÖ Message Working</div>
                            <pre>${JSON.stringify(response, null, 2)}</pre>
                        `;
              console.log("Message test successful:", response);
            }
          });
        } catch (error) {
          document.getElementById("messageResult").innerHTML = `
                    <div class="status error">‚ùå Message Setup Failed: ${error.message}</div>
                `;
          console.log("Message test setup failed:", error);
        }
      }

      function testFillForms() {
        console.log("Testing fill forms functionality...");

        // Test the injectFormFiller function directly
        const testUserData = {
          firstName: "Test",
          lastName: "User",
          email: "test@example.com",
          phone: "555-123-4567",
        };

        try {
          // Try to access the popup manager if available
          if (
            typeof popupManager !== "undefined" &&
            popupManager.injectFormFiller
          ) {
            const result = popupManager.injectFormFiller(testUserData);
            document.getElementById("fillFormsResult").innerHTML = `
                        <div class="status success">‚úÖ Fill Forms Test Complete - Filled ${result} fields</div>
                    `;
            console.log("Fill forms test successful:", result);
          } else {
            // Manual test
            const fields = document.querySelectorAll(
              "#firstName, #lastName, #email, #phone"
            );
            let filled = 0;

            fields.forEach((field) => {
              const fieldType = field.id;
              if (testUserData[fieldType] && !field.value) {
                field.value = testUserData[fieldType];
                field.dispatchEvent(new Event("input", { bubbles: true }));
                filled++;
              }
            });

            document.getElementById("fillFormsResult").innerHTML = `
                        <div class="status success">‚úÖ Manual Fill Test Complete - Filled ${filled} fields</div>
                    `;
            console.log("Manual fill test completed:", filled);
          }
        } catch (error) {
          document.getElementById("fillFormsResult").innerHTML = `
                    <div class="status error">‚ùå Fill Forms Test Failed: ${error.message}</div>
                `;
          console.log("Fill forms test failed:", error);
        }
      }

      // Initialize
      window.addEventListener("DOMContentLoaded", () => {
        displayBrowserInfo();
        checkExtensionStatus();

        // Set up field listeners
        const fields = document.querySelectorAll(".test-field");
        fields.forEach((field) => {
          field.addEventListener("focus", () => {
            console.log(`Field focused: ${field.id}`);
          });
        });

        console.log("Comprehensive debug tool loaded");
      });

      // Auto-refresh status every 5 seconds
      setInterval(checkExtensionStatus, 5000);
    </script>
  </body>
</html>
